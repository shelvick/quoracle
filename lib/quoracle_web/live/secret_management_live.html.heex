<div class="container mx-auto p-4" data-active-tab={@active_tab}>
  <h1 class="text-2xl font-bold mb-4">Settings</h1>

  <!-- Tab Navigation (R1-R2) -->
  <div class="border-b border-gray-200 mb-4">
    <nav class="flex space-x-8">
      <button
        phx-click="switch_tab"
        phx-value-tab="credentials"
        class={"tab #{if @active_tab == :credentials, do: "tab-active", else: ""}"}
      >
        Credentials
      </button>
      <button
        phx-click="switch_tab"
        phx-value-tab="model_config"
        class={"tab #{if @active_tab == :model_config, do: "tab-active", else: ""}"}
      >
        Model Config
      </button>
      <button
        phx-click="switch_tab"
        phx-value-tab="profiles"
        class={"tab #{if @active_tab == :profiles, do: "tab-active", else: ""}"}
      >
        Profiles
      </button>
      <button
        phx-click="switch_tab"
        phx-value-tab="secrets"
        class={"tab #{if @active_tab == :secrets, do: "tab-active", else: ""}"}
      >
        Secrets
      </button>
    </nav>
  </div>

  <!-- Secrets Tab Content -->
  <%= if @active_tab == :secrets do %>
    <div data-tab="secrets">
      <!-- Search Form -->
      <form id="search-form" phx-change="search">
        <input type="text" name="search[term]" value={@search_term} placeholder="Search secrets..." />
      </form>

      <!-- Action Button -->
      <div class="flex space-x-2 mb-4">
        <button phx-click="new_secret" class="btn-primary">Add Secret</button>
      </div>

      <!-- Secrets List -->
      <div class="space-y-2">
        <%= for item <- Enum.filter(@items, & &1.type == :secret) do %>
          <div class="item" data-name={item.name}>
            <div class="flex justify-between items-center">
              <div>
                <span class="badge badge-blue">SECRET</span>
                <span class="font-mono"><%= item.name %></span>
                <%= if item.description do %>
                  <span class="text-gray-600 text-sm"><%= item.description %></span>
                <% end %>
              </div>
              <div class="space-x-2">
                <button phx-click="edit" phx-value-id={item.id} data-action="edit" data-id={item.id}>Edit</button>
                <button phx-click="delete" phx-value-id={item.id} data-action="delete" data-id={item.id}>Delete</button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Credentials Tab Content (R3-R9, R15-R18) -->
  <%= if @active_tab == :credentials do %>
    <div data-tab="credentials">
      <!-- LLMDB Error Message (R4) -->
      <%= unless @llmdb_available do %>
        <div class="text-red-600 mb-4">
          Model database not loaded. Cannot create credentials.
        </div>
      <% end %>

      <!-- Action Button -->
      <div class="flex space-x-2 mb-4">
        <button phx-click="new_credential" class="btn-primary">Add Credential</button>
      </div>

      <!-- Credentials List -->
      <div class="space-y-2">
        <%= for item <- Enum.filter(@items, & &1.type == :credential) do %>
          <div class="item" data-name={item.name} data-model={item.model_id}>
            <div class="flex justify-between items-center">
              <div>
                <span class="badge badge-green">CREDENTIAL</span>
                <span class="font-mono"><%= item.name %></span>
                <%= if item.model_spec do %>
                  <span class="text-gray-600 text-sm"><%= item.model_spec %></span>
                <% end %>
              </div>
              <div class="space-x-2">
                <button phx-click="edit" phx-value-id={item.id} data-action="edit" data-id={item.id}>Edit</button>
                <button phx-click="delete" phx-value-id={item.id} data-action="delete" data-id={item.id}>Delete</button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Model Config Tab Content (R10-R14) -->
  <%= if @active_tab == :model_config do %>
    <div data-tab="model_config">
      <.form for={%{}} id="model-config-form" phx-submit="save_model_config">
        <!-- Embedding Model (single select) (R12) -->
        <div class="mb-4">
          <h3 class="font-semibold">Embedding Model</h3>
          <p class="text-sm text-gray-500 mb-2">Model for text embeddings</p>
          <select name="model_config[embedding_model]" class="w-full">
            <option value="">Select embedding model...</option>
            <%= for {label, value} <- @credentialed_models do %>
              <option value={value} selected={value == @embedding_model}><%= label %></option>
            <% end %>
          </select>
        </div>

        <!-- Answer Engine Model (single select) -->
        <div class="mb-4">
          <h3 class="font-semibold">Answer Engine Model</h3>
          <p class="text-sm text-gray-500 mb-2">Model for web-grounded answers</p>
          <select name="model_config[answer_engine_model]" class="w-full">
            <option value="">Select answer engine model...</option>
            <%= for {label, value} <- @credentialed_models do %>
              <option value={value} selected={value == @answer_engine_model}><%= label %></option>
            <% end %>
          </select>
        </div>

        <!-- Summarization Model (single select, chat-capable only) (R19-R22) -->
        <div class="mb-4">
          <h3 class="font-semibold">Summarization Model</h3>
          <p class="text-sm text-gray-500 mb-2">Model for conversation history summarization</p>
          <select name="model_config[summarization_model]" class="w-full">
            <option value="">Select summarization model...</option>
            <%= for {label, value} <- @chat_capable_models do %>
              <option value={value} selected={value == @summarization_model}><%= label %></option>
            <% end %>
          </select>
        </div>

        <!-- Image Generation Models (multi-select, image models only) (R23-R28) -->
        <div class="mb-4">
          <h3 class="font-semibold">Image Generation Models</h3>
          <p class="text-sm text-gray-500 mb-2">Models for parallel image generation (select all models to use)</p>
          <select name="model_config[image_generation_models][]" multiple class="w-full h-32">
            <%= for {label, value} <- @image_credentialed_models do %>
              <option value={value} selected={value in @image_generation_models}><%= label %></option>
            <% end %>
          </select>
        </div>

        <button type="submit" class="btn-primary">Save Configuration</button>
      </.form>
    </div>
  <% end %>

  <!-- Profiles Tab Content -->
  <%= if @active_tab == :profiles do %>
    <div data-tab="profiles">
      <h2 class="text-xl font-semibold mb-4">Profiles</h2>

      <!-- Action Button -->
      <div class="flex space-x-2 mb-4">
        <button phx-click="new_profile" class="btn-primary">New Profile</button>
      </div>

      <!-- Profiles List -->
      <div class="space-y-2">
        <%= for profile <- @profiles do %>
          <div class="item p-3 border rounded" data-name={profile.name}>
            <div class="flex justify-between items-center">
              <div>
                <span class="font-semibold"><%= profile.name %></span>
                <span class="text-gray-600 text-sm ml-2"><%= display_capability_groups(profile.capability_groups) %></span>
                <%= if profile.description do %>
                  <p class="text-gray-500 text-sm"><%= profile.description %></p>
                <% end %>
              </div>
              <div class="space-x-2">
                <button phx-click="edit_profile" phx-value-id={profile.id}>Edit</button>
                <button phx-click="delete_profile" phx-value-id={profile.id}>Delete</button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Pagination Controls -->
  <%= if @total_items > @page_size * @page do %>
    <div class="mt-4">
      <button phx-click="next_page" class="btn-secondary">Next Page</button>
    </div>
  <% end %>

  <!-- Modals -->
  <%= if @show_modal == :new_secret do %>
    <div id="secret-modal" class="modal">
      <.form for={@modal_changeset} id="secret-form" phx-submit="save_secret" phx-change="validate_secret">
        <input type="text" name="secret[name]" value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :name), else: ""} placeholder="Secret name" />
        <%= if @modal_changeset && @modal_changeset.errors[:name] do %>
          <span class="error-message"><%= elem(@modal_changeset.errors[:name], 0) %></span>
        <% end %>
        <input type="password" name="secret[value]" value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :value), else: ""} placeholder="Secret value" />
        <%= if @modal_changeset && @modal_changeset.errors[:value] do %>
          <span class="error-message"><%= elem(@modal_changeset.errors[:value], 0) %></span>
        <% end %>
        <input type="text" name="secret[description]" value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :description), else: ""} placeholder="Description (optional)" />
        <%= if @modal_changeset && @modal_changeset.errors[:description] do %>
          <span class="error-message"><%= elem(@modal_changeset.errors[:description], 0) %></span>
        <% end %>
        <button type="submit">Save</button>
        <button type="button" phx-click="close_modal">Cancel</button>
      </.form>
    </div>
  <% end %>

  <%= if @show_modal == :edit_secret do %>
    <div id="edit-secret-modal" class="modal">
      <.form for={@modal_changeset} id="edit-secret-form" phx-submit="save_secret">
        <input type="password" name="secret[value]" placeholder="New value" />
        <%= if @modal_changeset && @modal_changeset.errors[:value] do %>
          <span class="error-message"><%= elem(@modal_changeset.errors[:value], 0) %></span>
        <% end %>
        <input type="text" name="secret[description]" value={@selected_item.description} />
        <%= if @modal_changeset && @modal_changeset.errors[:description] do %>
          <span class="error-message"><%= elem(@modal_changeset.errors[:description], 0) %></span>
        <% end %>
        <%= if @modal_changeset && @modal_changeset.errors[:name] do %>
          <span class="error-message">Name already exists</span>
        <% end %>
        <button type="submit">Update</button>
        <button type="button" phx-click="close_modal">Cancel</button>
      </.form>
    </div>
  <% end %>

  <%= if @show_modal == :new_credential do %>
    <div id="credential-modal" class="modal">
      <.form for={@modal_changeset} id="credential-form" phx-submit="save_credential" phx-change="validate_credential">
        <!-- LLMDB Model Dropdown (R3, R5) -->
        <%= if @llmdb_available do %>
          <div class="mb-2">
            <label>Model</label>
            <select name="credential[model_spec]" class="w-full">
              <option value="">Select a model...</option>
              <%= for {label, value} <- @available_models do %>
                <option value={value} selected={@modal_changeset && Ecto.Changeset.get_field(@modal_changeset, :model_spec) == value}><%= label %></option>
              <% end %>
            </select>
          </div>
        <% end %>

        <!-- Model ID (auto-populated from model_spec) (R5) -->
        <input
          type="text"
          name="credential[model_id]"
          value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :model_id), else: ""}
          placeholder="Model ID (e.g., azure:o1)"
        />

        <!-- API Key / Service Account JSON (provider-dependent) -->
        <%= if @selected_provider == "google-vertex" do %>
          <div class="mb-2">
            <label class="block text-sm font-medium mb-1">Service Account JSON</label>
            <textarea
              name="credential[api_key]"
              rows="12"
              class="w-full font-mono text-sm"
              placeholder='{"type": "service_account", "project_id": "...", ...}'
            ><%= if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :api_key), else: "" %></textarea>
            <p class="text-xs text-gray-500 mt-1">Paste your complete service account JSON from Google Cloud Console</p>
          </div>
        <% else %>
          <input
            type="password"
            name="credential[api_key]"
            value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :api_key), else: ""}
            placeholder="API Key"
          />
        <% end %>

        <!-- Azure-specific fields (R6) -->
        <%= if @selected_provider == "azure" do %>
          <input
            type="text"
            name="credential[endpoint_url]"
            value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :endpoint_url), else: ""}
            placeholder="Endpoint URL (e.g., https://your-resource.openai.azure.com)"
          />
          <input
            type="text"
            name="credential[deployment_id]"
            value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :deployment_id), else: ""}
            placeholder="Deployment ID"
          />
        <% end %>

        <!-- Google Vertex-specific fields (R7) -->
        <%= if @selected_provider == "google-vertex" do %>
          <input
            type="text"
            name="credential[resource_id]"
            value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :resource_id), else: ""}
            placeholder="Project ID"
          />
          <% current_region = if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :region), else: nil %>
          <select name="credential[region]">
            <option value="">Select region...</option>
            <option value="global" selected={current_region == "global"}>global (required for Gemini 3)</option>
            <option value="us-central1" selected={current_region == "us-central1"}>us-central1</option>
            <option value="us-east1" selected={current_region == "us-east1"}>us-east1</option>
            <option value="europe-west1" selected={current_region == "europe-west1"}>europe-west1</option>
            <option value="asia-northeast1" selected={current_region == "asia-northeast1"}>asia-northeast1</option>
          </select>
        <% end %>

        <!-- Amazon Bedrock-specific fields (R8) -->
        <%= if @selected_provider == "amazon-bedrock" do %>
          <% bedrock_region = if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :region), else: nil %>
          <select name="credential[region]">
            <option value="">Select region...</option>
            <option value="us-east-1" selected={bedrock_region == "us-east-1"}>us-east-1</option>
            <option value="us-west-2" selected={bedrock_region == "us-west-2"}>us-west-2</option>
            <option value="eu-west-1" selected={bedrock_region == "eu-west-1"}>eu-west-1</option>
            <option value="ap-northeast-1" selected={bedrock_region == "ap-northeast-1"}>ap-northeast-1</option>
          </select>
        <% end %>

        <%= if @modal_changeset && @modal_changeset.errors[:model_id] do %>
          <span class="error-message">Model ID is required (format: provider:model)</span>
        <% end %>
        <%= if @modal_changeset && @modal_changeset.errors[:api_key] do %>
          <span class="error-message">Invalid API key format</span>
        <% end %>
        <button type="submit">Save</button>
        <button type="button" phx-click="close_modal">Cancel</button>
      </.form>
    </div>
  <% end %>

  <%= if @show_modal == :edit_credential do %>
    <div id="credential-modal" class="modal">
      <.form for={@modal_changeset} id="credential-form" phx-submit="save_credential" phx-change="validate_credential">
        <!-- Model Spec (read-only when editing) -->
        <div class="mb-2">
          <label>Model</label>
          <input
            type="text"
            name="credential[model_spec]"
            value={if @selected_item, do: @selected_item.model_spec, else: ""}
            readonly
            class="bg-gray-100"
          />
        </div>

        <!-- Model ID -->
        <input
          type="text"
          name="credential[model_id]"
          value={if @selected_item, do: @selected_item.model_id, else: ""}
          placeholder="Model ID"
        />

        <!-- API Key / Service Account JSON (provider-dependent) -->
        <%= if @selected_provider == "google-vertex" do %>
          <div class="mb-2">
            <label class="block text-sm font-medium mb-1">Service Account JSON</label>
            <textarea
              name="credential[api_key]"
              rows="12"
              class="w-full font-mono text-sm"
              placeholder="Leave blank to keep current, or paste new JSON"
            ><%= if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :api_key), else: "" %></textarea>
            <p class="text-xs text-gray-500 mt-1">Paste your complete service account JSON from Google Cloud Console</p>
          </div>
        <% else %>
          <input
            type="password"
            name="credential[api_key]"
            value={if @modal_changeset, do: Ecto.Changeset.get_field(@modal_changeset, :api_key), else: ""}
            placeholder="API Key (leave blank to keep current)"
          />
        <% end %>

        <!-- Azure-specific fields (R6, R16) -->
        <%= if @selected_provider == "azure" do %>
          <input
            type="text"
            name="credential[endpoint_url]"
            value={if @selected_item, do: Map.get(@selected_item, :endpoint_url, ""), else: ""}
            placeholder="Endpoint URL"
          />
          <input
            type="text"
            name="credential[deployment_id]"
            value={if @selected_item, do: Map.get(@selected_item, :deployment_id, ""), else: ""}
            placeholder="Deployment ID"
          />
        <% end %>

        <!-- Google Vertex-specific fields (R7, R16) -->
        <%= if @selected_provider == "google-vertex" do %>
          <input
            type="text"
            name="credential[resource_id]"
            value={if @selected_item, do: Map.get(@selected_item, :resource_id, ""), else: ""}
            placeholder="Project ID"
          />
          <select name="credential[region]">
            <option value="">Select region...</option>
            <option value="us-central1" selected={@selected_item && Map.get(@selected_item, :region) == "us-central1"}>us-central1</option>
            <option value="us-east1" selected={@selected_item && Map.get(@selected_item, :region) == "us-east1"}>us-east1</option>
            <option value="europe-west1" selected={@selected_item && Map.get(@selected_item, :region) == "europe-west1"}>europe-west1</option>
            <option value="asia-northeast1" selected={@selected_item && Map.get(@selected_item, :region) == "asia-northeast1"}>asia-northeast1</option>
          </select>
        <% end %>

        <!-- Amazon Bedrock-specific fields (R8, R16) -->
        <%= if @selected_provider == "amazon-bedrock" do %>
          <select name="credential[region]">
            <option value="">Select region...</option>
            <option value="us-east-1" selected={@selected_item && Map.get(@selected_item, :region) == "us-east-1"}>us-east-1</option>
            <option value="us-west-2" selected={@selected_item && Map.get(@selected_item, :region) == "us-west-2"}>us-west-2</option>
            <option value="eu-west-1" selected={@selected_item && Map.get(@selected_item, :region) == "eu-west-1"}>eu-west-1</option>
            <option value="ap-northeast-1" selected={@selected_item && Map.get(@selected_item, :region) == "ap-northeast-1"}>ap-northeast-1</option>
          </select>
        <% end %>

        <%= if @modal_changeset && @modal_changeset.errors[:model_id] do %>
          <span class="error-message">Model ID is required</span>
        <% end %>
        <%= if @modal_changeset && @modal_changeset.errors[:api_key] do %>
          <span class="error-message">Invalid API key format</span>
        <% end %>
        <button type="submit">Update</button>
        <button type="button" phx-click="close_modal">Cancel</button>
      </.form>
    </div>
  <% end %>

  <%= if @show_modal in [:new_profile, :edit_profile] do %>
    <div id="profile-modal" class="modal">
      <h3 class="text-lg font-semibold mb-4">
        <%= if @show_modal == :new_profile, do: "New Profile", else: "Edit Profile" %>
      </h3>
      <.form for={@profile_changeset} as={:profile} id="profile-form" phx-submit="save_profile" phx-change="validate_profile">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Name</label>
          <input
            type="text"
            name="profile[name]"
            value={Ecto.Changeset.get_field(@profile_changeset, :name)}
            placeholder="Profile name"
            class="w-full border rounded px-3 py-2"
          />
          <%= if @profile_changeset.action && @profile_changeset.errors[:name] do %>
            <span class="error-message text-red-600 text-sm"><%= elem(@profile_changeset.errors[:name], 0) %></span>
          <% end %>
          <p class="text-xs text-gray-500 mt-1">Visible to agents. Use a descriptive name they can reference.</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Description</label>
          <input
            type="text"
            name="profile[description]"
            value={Ecto.Changeset.get_field(@profile_changeset, :description)}
            placeholder="Description (optional)"
            class="w-full border rounded px-3 py-2"
          />
          <p class="text-xs text-gray-500 mt-1">Visible to agents. Explain the profile's purpose or constraints.</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Capability Groups</label>
          <p class="text-xs text-gray-500 mb-2">Select capabilities to enable. Empty = base actions only.</p>
          <div class="grid grid-cols-2 gap-2 border rounded p-3">
            <% current_groups = Ecto.Changeset.get_field(@profile_changeset, :capability_groups) || [] %>
            <%= for {group, description} <- QuoracleWeb.SecretManagementLive.ProfileHelpers.ordered_capability_groups() do %>
              <label class="flex items-start gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  name="profile[capability_groups][]"
                  value={group}
                  checked={to_string(group) in Enum.map(current_groups, &to_string/1)}
                  class="rounded mt-0.5 w-4 h-4 flex-shrink-0"
                />
                <span class="text-sm leading-tight">
                  <span class="font-medium"><%= group %></span>
                  <span class="block text-xs text-gray-500"><%= description %></span>
                </span>
              </label>
            <% end %>
          </div>
          <%= if @profile_changeset.errors[:capability_groups] do %>
            <span class="error-message text-red-600 text-sm"><%= elem(@profile_changeset.errors[:capability_groups], 0) %></span>
          <% end %>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Models</label>
          <select name="profile[model_pool][]" multiple class="w-full h-32 border rounded">
            <%= for {label, value} <- @credentialed_models do %>
              <option value={value} selected={value in (Ecto.Changeset.get_field(@profile_changeset, :model_pool) || [])}>
                <%= label %>
              </option>
            <% end %>
          </select>
          <%= if @profile_changeset.errors[:model_pool] do %>
            <span class="error-message text-red-600 text-sm">must have at least one model</span>
          <% end %>
        </div>

        <div class="flex space-x-2">
          <button type="submit" class="btn-primary">Save</button>
          <button type="button" phx-click="close_modal">Cancel</button>
        </div>
      </.form>
    </div>
  <% end %>

  <%= if @show_modal == :confirm_delete do %>
    <div id="confirm-delete-modal" class="modal">
      <p>Are you sure you want to delete <%= @selected_item.name %>?</p>
      <!-- Delete warning for active config (R18) -->
      <%= if @delete_warning do %>
        <div class="text-orange-600 mb-2"><%= @delete_warning %></div>
      <% end %>
      <%= if @error_message do %>
        <div class="error-message"><%= @error_message %></div>
        <div class="error-details"><%= @error_message %></div>
      <% end %>
      <button id="confirm-delete-button" phx-click="confirm_delete">Yes, Delete</button>
      <button phx-click="close_modal">Cancel</button>
    </div>
  <% end %>

  <%= if @show_modal != :none do %>
    <div class="modal-backdrop" phx-click="close_modal"></div>
  <% end %>
</div>
